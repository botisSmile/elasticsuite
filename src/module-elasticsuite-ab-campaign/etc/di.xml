<?xml version="1.0"?>
<!--
/**
 * Smile_ElasticsuiteAbCampaign dependency injection configuration.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Smile ElasticSuite to newer
 * versions in the future.
 *
 * @category  Smile
 * @package   Smile\ElasticsuiteAbCampaign
 * @author    Pierre Le Maguer <pierre.lemaguer@smile.fr>
 * @copyright 2021 Smile
 * @license   Licensed to Smile-SA. All rights reserved. No warranty, explicit or implicit, provided.
 *            Unauthorized copying of this file, via any medium, is strictly prohibited.
 */
 -->
<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="urn:magento:framework:ObjectManager/etc/config.xsd">
    <!-- Campaign Model Declaration -->
    <type name="Magento\Framework\Model\Entity\RepositoryFactory">
        <arguments>
            <argument name="entities" xsi:type="array">
                <item name="Smile\ElasticsuiteAbCampaign\Api\Data\CampaignInterface" xsi:type="string">Smile\ElasticsuiteAbCampaign\Api\CampaignRepositoryInterface</item>
                <item name="Smile\ElasticsuiteAbCampaign\Api\Data\CampaignSessionInterface" xsi:type="string">Smile\ElasticsuiteAbCampaign\Api\CampaignSessionRepositoryInterface</item>
            </argument>
        </arguments>
    </type>

    <type name="Magento\Framework\EntityManager\MetadataPool">
        <arguments>
            <argument name="metadata" xsi:type="array">
                <item name="Smile\ElasticsuiteAbCampaign\Api\Data\CampaignInterface" xsi:type="array">
                    <item name="entityTableName" xsi:type="string">smile_elasticsuite_campaign</item>
                    <item name="identifierField" xsi:type="string">campaign_id</item>
                </item>
                <item name="Smile\ElasticsuiteAbCampaign\Api\Data\CampaignSessionInterface" xsi:type="array">
                    <item name="entityTableName" xsi:type="string">smile_elasticsuite_campaign_session</item>
                    <item name="identifierField" xsi:type="string">campaign_session_id</item>
                </item>
            </argument>
        </arguments>
    </type>

    <type name="Magento\Framework\EntityManager\HydratorPool">
        <arguments>
            <argument name="hydrators" xsi:type="array">
                <item name="Smile\ElasticsuiteAbCampaign\Api\Data\CampaignInterface" xsi:type="string">Magento\Framework\EntityManager\AbstractModelHydrator</item>
                <item name="Smile\ElasticsuiteAbCampaign\Api\Data\CampaignSessionInterface" xsi:type="string">Magento\Framework\EntityManager\AbstractModelHydrator</item>
            </argument>
        </arguments>
    </type>

    <preference for="Smile\ElasticsuiteAbCampaign\Api\CampaignRepositoryInterface" type="Smile\ElasticsuiteAbCampaign\Model\CampaignRepository" />
    <preference for="Smile\ElasticsuiteAbCampaign\Api\CampaignSessionRepositoryInterface" type="Smile\ElasticsuiteAbCampaign\Model\CampaignSessionRepository" />
    <preference for="Smile\ElasticsuiteAbCampaign\Api\CampaignManagerInterface" type="Smile\ElasticsuiteAbCampaign\Model\CampaignManager" />
    <preference for="Smile\ElasticsuiteAbCampaign\Api\Campaign\OptimizerManagerInterface" type="Smile\ElasticsuiteAbCampaign\Model\Campaign\OptimizerManager" />
    <preference for="Smile\ElasticsuiteAbCampaign\Api\Data\CampaignInterface" type="Smile\ElasticsuiteAbCampaign\Model\Campaign" />
    <preference for="Smile\ElasticsuiteAbCampaign\Api\Data\CampaignSessionInterface" type="Smile\ElasticsuiteAbCampaign\Model\CampaignSession" />
    <preference for="Smile\ElasticsuiteAbCampaign\Api\Data\CampaignSearchResultsInterface" type="Magento\Framework\Api\SearchResults" />
    <preference for="Smile\ElasticsuiteAbCampaign\Api\Data\CampaignSessionSearchResultsInterface" type="Magento\Framework\Api\SearchResults" />
    <preference for="Smile\ElasticsuiteAbCampaign\Api\CampaignAggregatorInterface" type="Smile\ElasticsuiteAbCampaign\Model\CampaignAggregator" />

    <!-- Campaign Containers -->
    <type name="Smile\ElasticsuiteAbCampaign\Model\Search\Request\Product\Source\Containers">
        <arguments>
            <argument name="allowedContainers" xsi:type="array">
                <item name="quick_search_container" xsi:type="string">quick_search_container</item>
                <item name="catalog_product_autocomplete" xsi:type="string">catalog_product_autocomplete</item>
                <item name="catalog_view_container" xsi:type="string">catalog_view_container</item>
            </argument>
        </arguments>
    </type>

    <!-- Campaign Validators -->
    <type name="Smile\ElasticsuiteAbCampaign\Model\Campaign\CompositeValidator">
        <arguments>
            <argument name="dataValidators" xsi:type="array">
                <item name="date" xsi:type="object">Smile\ElasticsuiteAbCampaign\Model\Campaign\Validator\Date</item>
                <item name="availability" xsi:type="object">Smile\ElasticsuiteAbCampaign\Model\Campaign\Validator\Availability</item>
                <item name="optimizer" xsi:type="object">Smile\ElasticsuiteAbCampaign\Model\Campaign\Validator\Optimizer</item>
            </argument>
        </arguments>
    </type>

    <!-- Handle saving of relationship between campaign and categories or search terms -->
    <type name="Magento\Framework\EntityManager\Operation\ExtensionPool">
        <arguments>
            <argument name="extensionActions" xsi:type="array">
                <item name="Smile\ElasticsuiteAbCampaign\Api\Data\CampaignInterface" xsi:type="array">
                    <item name="create" xsi:type="array">
                        <item name="campaignLimitationPersistor" xsi:type="string">Smile\ElasticsuiteAbCampaign\Model\Campaign\Limitation\SaveHandler</item>
                        <item name="campaignOptimizerPersistor" xsi:type="string">Smile\ElasticsuiteAbCampaign\Model\Campaign\Optimizer\SaveHandler</item>
                    </item>
                    <item name="update" xsi:type="array">
                        <item name="campaignLimitationPersistor" xsi:type="string">Smile\ElasticsuiteAbCampaign\Model\Campaign\Limitation\SaveHandler</item>
                        <item name="campaignOptimizerPersistor" xsi:type="string">Smile\ElasticsuiteAbCampaign\Model\Campaign\Optimizer\SaveHandler</item>
                    </item>
                    <item name="read" xsi:type="array">
                        <item name="campaignLimitationReader" xsi:type="string">Smile\ElasticsuiteAbCampaign\Model\Campaign\Limitation\ReadHandler</item>
                        <item name="campaignOptimizerReader" xsi:type="string">Smile\ElasticsuiteAbCampaign\Model\Campaign\Optimizer\ReadHandler</item>
                    </item>
                </item>
            </argument>
        </arguments>
    </type>

    <!-- Prevent table column names collision due to
         Smile\ElasticsuiteAbCampaign\Model\ResourceModel\Campaign\Optimizer::joinCampaignToOptimizerCollection
          Addressed by OptimizerWithoutCampaignDataProvider in etc/adminghtml.di.xml -->
    <type name="Smile\ElasticsuiteCatalogOptimizer\Model\ResourceModel\Optimizer\CollectionFactory">
        <plugin name="declare_optimizer_collection_self_columns"
                type="Smile\ElasticsuiteAbCampaign\Plugin\CatalogOptimizer\ResourceModel\Optimizer\CollectionFactoryPlugin"
                disabled="true" />
    </type>

    <type name="Smile\ElasticsuiteTracker\Model\ResourceModel\SessionIndex">
        <plugin name="session_aggregator_add_ab_campaign_data"
                type="Smile\ElasticsuiteAbCampaign\Plugin\Tracker\Model\ResourceModel\SessionIndexPlugin" />
    </type>

    <type name="Smile\ElasticsuiteAbCampaign\Model\Search\Usage\Campaign\Report">
        <arguments>
            <argument name="kpiAggregator" xsi:type="object">Smile\ElasticsuiteAbCampaign\Model\Search\Campaign\Usage\KpiAggregator</argument>
        </arguments>
    </type>

    <!-- Search usage Campaign report config -->
    <virtualType name="Smile\ElasticsuiteAbCampaign\Model\Search\Campaign\Usage\KpiAggregator" type="Smile\ElasticsuiteAbCampaign\Model\Search\Campaign\KpiAggregator">
        <arguments>
            <argument name="queryProviders" xsi:type="array">
                <item name="dateFilter" xsi:type="object">Smile\ElasticsuiteAnalytics\Model\Report\Session\DateFilterQueryProvider</item>
            </argument>
        </arguments>
    </virtualType>

    <type name="Smile\ElasticsuiteAbCampaign\Model\CampaignAggregator">
        <arguments>
            <argument name="kpiAggregator" xsi:type="object">Smile\ElasticsuiteAbCampaign\Model\Search\Campaign\Cron\KpiAggregator</argument>
        </arguments>
    </type>

    <virtualType name="Smile\ElasticsuiteAbCampaign\Model\Search\Campaign\Cron\KpiAggregator" type="Smile\ElasticsuiteAbCampaign\Model\Search\Campaign\KpiAggregator">
        <arguments>
            <argument name="queryProviders" xsi:type="array">
                <item name="dateFilter" xsi:type="object">Smile\ElasticsuiteAbCampaign\Model\Search\Campaign\DateFilterQueryProvider</item>
            </argument>
        </arguments>
    </virtualType>
</config>
